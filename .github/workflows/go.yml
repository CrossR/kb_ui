name: Compile

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build - ${{ matrix.pretty-name }}
    runs-on: "${{ matrix.os }}"

    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            pretty-name: Linux
            extra_flags: ""
            suffix: ""
          - os: macos-latest
            pretty-name: macOS
            extra_flags: ""
            suffix: ""
          - os: windows-latest
            pretty-name: Windows
            extra_flags: "-ldflags '-H=windowsgui'"
            suffix: ".exe"

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.18

      - name: Install dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt update
          sudo apt -y install libayatana-appindicator3-dev

      - name: Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
            ~/Library/Caches/go-build
            %LocalAppData%\go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build
        run: env CGO_ENABLED=1 GO111MODULE=on go build -ldflags "-X github.com/CrossR/kb_ui/tray.Version=${GITHUB_SHA::7}" -v ${{ matrix.extra_flags }}

      - name: Archive
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.os }}-kb_ui
          path: ./kb_ui${{ matrix.suffix }}
